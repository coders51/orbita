<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>orbita public documentation</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight, .highlight .w {
  color: #f8f8f2;
  background-color: #272822;
}
.highlight .err {
  color: #151515;
  background-color: #ac4142;
}
.highlight .c, .highlight .cd, .highlight .cm, .highlight .c1, .highlight .cs {
  color: #505050;
}
.highlight .cp {
  color: #f4bf75;
}
.highlight .nt {
  color: #f4bf75;
}
.highlight .o, .highlight .ow {
  color: #d0d0d0;
}
.highlight .p, .highlight .pi {
  color: #d0d0d0;
}
.highlight .gi {
  color: #90a959;
}
.highlight .gd {
  color: #ac4142;
}
.highlight .gh {
  color: #6a9fb5;
  background-color: #151515;
  font-weight: bold;
}
.highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
  color: #aa759f;
}
.highlight .kc {
  color: #d28445;
}
.highlight .kt {
  color: #d28445;
}
.highlight .kd {
  color: #d28445;
}
.highlight .s, .highlight .sb, .highlight .sc, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
  color: #90a959;
}
.highlight .sr {
  color: #75b5aa;
}
.highlight .si {
  color: #8f5536;
}
.highlight .se {
  color: #8f5536;
}
.highlight .nn {
  color: #f4bf75;
}
.highlight .nc {
  color: #f4bf75;
}
.highlight .no {
  color: #f4bf75;
}
.highlight .na {
  color: #6a9fb5;
}
.highlight .m, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mb, .highlight .mx {
  color: #90a959;
}
.highlight .ss {
  color: #90a959;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
  </head>

  <body class="index" data-languages="[&quot;shell&quot;,&quot;ruby&quot;,&quot;javascript&quot;,&quot;html&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <img src="images/logo.png" />
        <div class="lang-selector">
              <a href="#" data-language-name="shell">shell</a>
              <a href="#" data-language-name="ruby">ruby</a>
              <a href="#" data-language-name="javascript">javascript</a>
              <a href="#" data-language-name="html">html</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc">
      </div>
        <ul class="toc-footer">
            <li><a href='http://getorbita.io'>Follow orbita</a></li>
            <li>documentation version v.0.1</li>
            <li><a href='https://github.com/tripit/slate'>Documentation Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id="orbita">Orbita</h1>

<h2 id="summary">Summary</h2>

<ul>
<li><a href="/orbita-doc/#introduction">Introduction</a></li>
<li><a href="/orbita-doc/#general-architecture-details">General Architecture Details</a></li>
<li><a href="/orbita-doc/#quick-reference-for-setup-of-a-production-server">Quick reference for a setup of a production server</a></li>
<li><a href="/orbita-doc/#http-api-documentation">HTTP API Documentation</a></li>
<li><a href="/orbita-doc/#authentication-amp-authorization">Authentication and Authorization</a></li>
<li><a href="/orbita-doc/#orbita-components-api">Orbita Components API</a></li>
<li><a href="/orbita-doc/#verify-jwt-token">Verify JWT</a></li>
<li><a href="/orbita-doc/#domain-events">Domain Events</a></li>
<li><a href="/orbita-doc/#how-to-create-new-application-and-use-all-orbita-services">How to create new application and use all orbita services</a></li>
<li><a href="/orbita-doc/#how-to-store-user-data-in-orbita-bucket-service">How to store user data in Orbita Bucket service</a></li>
</ul>

<h2 id="deployment-and-server-configuration">Deployment and Server Configuration</h2>

<ul>
<li><a href="/orbita-doc/#how-to-setup-a-new-orbita-instance">How to Setup A New Orbita Instance</a></li>
<li><a href="/orbita-doc/#vagrant-provisioning">Provisioning Vagrant</a></li>
<li><a href="/orbita-doc/#provisioning-staging-server">Provisioning Staging Server</a></li>
<li><a href="/orbita-doc/#deploying-orbita-services">How to Deploy Services</a></li>
<li><a href="/orbita-doc/#dev-machine-setup">Dev Machine Setup</a></li>
</ul>

<h1 id="introduction">Introduction</h1>

<p>orbita is a product useful to:</p>

<ul>
<li>centralize all your user base on a unique database</li>
<li>analyze their behaviour (misure their action and how they interact with you)</li>
<li>have web components to integrate in all your apps</li>
<li>have a set of API for your web and mobile apps to speed up development</li>
<li>have landing page to mix your marketing analysis with real registration to your platform</li>
<li>distribute your brand connection with plugin</li>
<li>create a network of your users with a graph db</li>
<li>have realtime notification between your different application</li>
<li>store big data associated to your users</li>
<li>have webhook with your mailchimp list</li>
</ul>

<p>Using orbita you can reduce your time to market and your time to break even</p>

<p>orbita is a product by <a href="http://coders51.com">coders51</a></p>

<ul>
<li>This repository&rsquo;s wiki will hold the documentation about: API, domain concepts, shared data, etc&hellip;</li>
<li>Setup process and project automation scripts</li>
<li>Integration and smoke tests</li>
</ul>

<p>This projects is based on microservices and exchange <a href="#domain-events">domain events</a> on a <a href="event-bus">event bus</a>.</p>

<p>The actual services are:</p>

<ul>
<li>OAuth service - It&rsquo;s the core of orbita. All the application and service use api from oauth. You can have a link/button in all your app: CONNECT WITH MY BRAND easy as you make &ldquo;connect with facebook&rdquo;.</li>
<li>Networking service - This service maps the relationships between users and other entities. It responds to events like <code class="prettyprint">&quot;FriendshipRequested&quot;</code> and similar events that may involve creating of, updating of and querying by relationships. In the case of a <code class="prettyprint">&quot;FriendshipRequested&quot;</code> event, a <code class="prettyprint">FriendRequest</code> between two users is saved in its data store. Later on, this <code class="prettyprint">friend_request</code> may be accepted when this service receives <code class="prettyprint">&quot;FriendshipAccepted&quot;</code> event that involves the same two users. By default, this runs in <code class="prettyprint">localhost:4001</code> in development.</li>
<li>Notification service - A realtime service for every kind of notification you need (web/desktop/mobile)</li>
<li>Wordpress plugin - give to your marketing manager the power to make landing page with visual composer and add a link/button to connect to your <strong>real</strong> user base</li>
<li>Bucket data service - store complex data different by application and user and use it to profile action and specific data</li>
<li>Dashboard analytic - profilation and marketing tool with mailchimp webhook</li>
</ul>

<h1 id="general-architecture-details">General Architecture Details</h1>

<p>orbita is a microservice collaboration platform.</p>

<p><img alt="Image of Yaktocat" src="images/orbitaarch.png" /></p>

<p>Some info about this kind of architecture:</p>

<ul>
<li><a href="http://www.martinfowler.com/eaaDev/EventCollaboration.html">Event Collaboration</a></li>
<li><a href="http://www.martinfowler.com/eaaDev/DomainEvent.html">Domain Event</a></li>
<li><a href="http://www.martinfowler.com/eaaDev/EventSourcing.html">Event Sourcing</a></li>
</ul>

<h1 id="quick-reference-for-setup-of-a-production-server">Quick reference for setup of a production server</h1>

<p>To install orbita on an existing server you need the following environment on your production server:</p>

<ul>
<li>RabbitMQ v 3.6 (we suggest 3.6.2)</li>
<li>PostgreSQL v 9.4&gt;, if you&rsquo;re in an Amazon server we suggest PostgresSQL RDS with multi-zone deploy and backup of a week.</li>
<li>nginx v 1.9.3&gt; (if you prefer it could be ok also Apache)</li>
<li>nodejs v LTS 4.4.4</li>
<li>package manager ruby RVM (if your prefer it&rsquo;s ok also rbenv)</li>
<li>passenger for integration between ruby and nginx/apache</li>
<li>supervisor to manage runtime process</li>
<li>orientdb [this is not mandatory at the beginning, you can choose to install it in a second moment]</li>
</ul>

<p>Components are in ruby on rails and elixir, for some component we need:</p>

<ul>
<li>Erlang v 18.3, and Elixir 1.2X we suggest esl-erlang downloadable from this link <a href="https://www.erlang-solutions.com/resources/download.html">https://www.erlang-solutions.com/resources/download.html</a> and <a href="http://elixir-lang.org/install.html#unix-and-unix-like">http://elixir-lang.org/install.html#unix-and-unix-like</a></li>
</ul>

<h1 id="http-api-documentation">HTTP API Documentation</h1>

<p>The documentation is written in markdown following the <a href="https://github.com/apiaryio/api-blueprint">API Blueprint Specification</a></p>

<h2 id="notifications-api">Notifications API</h2>

<p>Notification service</p>

<h3 id="group-user-notifications">Group User Notifications</h3>

<p>All these requests requires a JWT token to identify the user</p>

<h2 id="unread-notifications-users-id-notifications-unread">Unread Notifications [/users/{ID}/notifications/unread]</h2>

<p>All the unread notifications addressed to the identified user. The <code class="prettyprint">JWT_TOKEN</code> is given by the OAuth server and contains encrypted informations about the user.</p>

<ul>
<li>Parameters

<ul>
<li>ID: 42 (required, string) - OAuth user identifier</li>
</ul></li>
</ul>

<h3 id="retrieve-unread-notifications-get">Retrieve Unread Notifications [GET]</h3>

<p>Retrieve all the unread notifications of the user</p>

<ul>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Accept: application/json
    Authorization: Bearer {JWT_TOKEN}</p></li>
</ul></li>
<li><p>Response 200 (application/json)</p>

<ul>
<li><p>Body</p>

<p>[
      {
        &ldquo;id&rdquo;: 12,
        &ldquo;message&rdquo;: &ldquo;Rick has accepted your friendship request&rdquo;,
        &ldquo;from&rdquo;: &ldquo;7&rdquo;,
        &ldquo;to&rdquo;: &ldquo;8&rdquo;,
        &ldquo;require_input&rdquo;: false
      }
    ]</p></li>
</ul></li>
<li><p>Response 401</p></li>
</ul>

<h3 id="mark-notifications-as-read-delete">Mark Notifications As Read [DELETE]</h3>

<p>Mark all the unread notifications of the user as read</p>

<ul>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Authorization: Bearer {JWT_TOKEN}</p></li>
</ul></li>
<li><p>Response 202</p></li>
<li><p>Response 401</p></li>
</ul>

<h2 id="unread-notification-notifications-unread-id">Unread Notification [/notifications/unread/{ID}]</h2>

<p>Unread notification. The <code class="prettyprint">JWT_TOKEN</code> is given by the OAuth server and contains encrypted informations about the user.</p>

<ul>
<li>Parameters

<ul>
<li>ID: 77 (required, string) - Notification identifier</li>
</ul></li>
</ul>

<h3 id="mark-notification-as-read-delete">Mark Notification As Read [DELETE]</h3>

<p>Mark single notification as read. The authenticated user must be the sender or the receiver of the notification</p>

<ul>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Authorization: Bearer {JWT_TOKEN}</p></li>
</ul></li>
<li><p>Response 202</p></li>
<li><p>Response 401</p></li>
<li><p>Response 404</p></li>
</ul>

<h2 id="notification-notifications-id">Notification [/notifications/{ID}]</h2>

<p>Notification. The <code class="prettyprint">JWT_TOKEN</code> is given by the OAuth server and contains encrypted informations about the user.</p>

<ul>
<li>Parameters

<ul>
<li>ID: 77 (required, string) - Notification identifier</li>
</ul></li>
</ul>

<h3 id="retrieve-notification-get">Retrieve Notification [GET]</h3>

<p><strong>[NOT IMPLEMENTED YET]</strong> Retrieve single notification. The authenticated user must be the sender or the receiver of the notification</p>

<ul>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Accept: application/json
    Authorization: Bearer {JWT_TOKEN}</p></li>
</ul></li>
<li><p>Response 200 (application/json)</p>

<ul>
<li><p>Body</p>

<p>{
      &ldquo;id&rdquo;: 12,
      &ldquo;message&rdquo;: &ldquo;Rick has accepted your friendship request&rdquo;,
      &ldquo;from&rdquo;: &ldquo;7&rdquo;,
      &ldquo;to&rdquo;: &ldquo;8&rdquo;,
      &ldquo;read&rdquo;: true
    }</p></li>
</ul></li>
<li><p>Response 401</p></li>
</ul>

<h3 id="delete-notification-delete">Delete Notification [DELETE]</h3>

<p><strong>[NOT IMPLEMENTED YET]</strong> Delete the single notification.</p>

<ul>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Authorization: Bearer {JWT_TOKEN}</p></li>
</ul></li>
<li><p>Response 202</p></li>
<li><p>Response 401</p></li>
</ul>

<h3 id="enable-notifications-post-users-user-notifications-by-media-enabled">Enable notifications [POST /users/:user/notifications/by/:media/enabled]</h3>

<p>Enables a given notification media (e.g., email or websockets) for a given user.</p>

<ul>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Authorization: Bearer {JWT_TOKEN}
    Accept: application/json</p></li>
</ul></li>
<li><p>Response: 200</p></li>
</ul>

<h3 id="disable-notifications-post-users-user-notifications-by-media-disabled">Disable notifications [POST /users/:user/notifications/by/:media/disabled]</h3>

<p>Disables a given notification media (e.g., email or websockets) for a given user.</p>

<ul>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Authorization: Bearer {JWT_TOKEN}
    Accept: application/json</p></li>
</ul></li>
<li><p>Response: 200</p></li>
</ul>

<h3 id="read-notifications-settings-for-a-media-get-users-user-notifications-by-media">Read notifications settings for a media [GET /users/:user/notifications/by/:media]</h3>

<p>Tells whether notifications on the given <code class="prettyprint">:media</code> are enabled for the given <code class="prettyprint">:user</code>.</p>

<ul>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Authorization: Bearer {JWT_TOKEN}
    Accept: application/json</p></li>
</ul></li>
<li><p>Response: 200</p>

<ul>
<li><p>Body</p>

<p>{&ldquo;enabled&rdquo;: true}</p></li>
</ul></li>
</ul>

<h3 id="read-notifications-settings-for-all-media-get-users-user-notifications-by-media">Read notifications settings for all media [GET /users/:user/notifications/by/:media]</h3>

<p>Tells whether notifications are enabled/disabled for each media for the given <code class="prettyprint">:user</code>.</p>

<ul>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Authorization: Bearer {JWT_TOKEN}
    Accept: application/json</p></li>
</ul></li>
<li><p>Response: 200</p>

<ul>
<li><p>Body</p>

<p>{
      &ldquo;email&rdquo;: true,
      &ldquo;ws&rdquo;: false,
      &hellip;
    }</p></li>
</ul></li>
</ul>

<h3 id="group-websocket">Group WebSocket</h3>

<h2 id="websocket-library-js-app-js">WebSocket Library [/js/app.js]</h2>

<p>The library to use to establish the WebSocket connection. See <a href="http://www.phoenixframework.org/docs/channels">the official documentation</a> on how to use it client side.</p>

<h3 id="retrieve-websocket-library-get">Retrieve WebSocket Library [GET]</h3>

<ul>
<li>Response 200</li>
</ul>

<h2 id="websocket-handshake-socket-websocket-jwt_token-jwt_token">WebSocket Handshake [/socket/websocket?jwt_token={JWT_TOKEN}]</h2>

<p>To establish a WebSocket connection, the client sends a WebSocket handshake request, for which the server returns a WebSocket handshake response. The <code class="prettyprint">JWT_TOKEN</code> is given by the OAuth server and contains encrypted informations about the user.</p>

<ul>
<li>Parameters

<ul>
<li>JWT_TOKEN: &ldquo;eyJ0eXAiOiJKV&hellip;&rdquo; (required, string) - Authentication token</li>
</ul></li>
</ul>

<h3 id="websocket-handshake-get">WebSocket Handshake [GET]</h3>

<ul>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Upgrade: websocket
    Connection: Upgrade
    Cache-Control: no-cache</p></li>
</ul></li>
<li><p>Response 101</p></li>
</ul>

<h2 id="how-to-generate-html">How to generate HTML</h2>

<p>Using <a href="https://github.com/danielgtaylor/aglio">aglio</a> an HTML file can be generate starting from a Blueprint file</p>
<pre class="highlight shell"><code><span class="gp">&gt; </span>To install, use this code:

<span class="gp">$ </span>npm -g install aglio
</code></pre>
<pre class="highlight shell"><code><span class="gp">&gt; </span>HTML Generation

<span class="gp">$ </span>aglio -i http-api-mta-notifications.md -o http-api-mta-notifications.html
</code></pre>

<p>FORMAT: 1A</p>

<h2 id="networking-api">Networking API</h2>

<p>Networking service. The endpoints on this API expose resources that represent relationships across different users and things.</p>

<h2 id="group-friend-requests">Group Friend Requests</h2>

<p>The friend request resource represents a request to connect from one user to another. A friendship between users can only be created when a friendship request has been accepted. There are five(5) endpoints for this resource..</p>

<h2 id="list-of-friend-requests-friend_requests">List of Friend Requests [/friend_requests]</h2>

<p>A resource representing all of a user&rsquo;s friend requests.</p>

<h3 id="fetch-all-friend-requests-get">Fetch all Friend Requests [GET]</h3>

<p>Fetches all friend requests sent and received by a user. The user is identified through the <code class="prettyprint">Authorization</code> header provided.</p>

<ul>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Accept: application/json
    Authorization: Bearer {JWT_TOKEN}</p></li>
</ul></li>
<li><p>Response 200 (application/json)</p>

<ul>
<li><p>Body</p>

<p>[
      {
        &ldquo;oauth_id&rdquo;: &ldquo;12&rdquo;,
        &ldquo;received&rdquo;: true,
        &ldquo;sent&rdquo;: true
      }
    ]</p></li>
</ul></li>
</ul>

<h3 id="create-a-friend-request-post">Create a Friend Request [POST]</h3>

<p>It expects a <code class="prettyprint">to</code> param which should be an oauth_id of a user to whom the request is sent to. An <code class="prettyprint">Authorization</code> header is required to identify the user who sent the request. You may only create one (1) friend request between two (2) users.</p>

<ul>
<li><p>Parameters</p>

<ul>
<li>to: &ldquo;77&rdquo; (required, string) - User ID of the user to whom the request is addressed to.</li>
</ul></li>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Accept: application/json
    Authorization: Bearer {JWT_TOKEN}</p></li>
</ul></li>
<li><p>Response 200 (application/json)</p>

<ul>
<li><p>Body</p>

<p>[
      {
        &ldquo;oauth_id&rdquo;: &ldquo;12&rdquo;,
        &ldquo;sent&rdquo;: true
      }
    ]</p></li>
</ul></li>
</ul>

<h2 id="list-of-friend-requests-friend_requests-id">List of Friend Requests [/friend_requests/{id}]</h2>

<p>A resource representing all of a user&rsquo;s friend requests.</p>

<h3 id="deletes-a-friend-request-delete">Deletes a Friend Request [DELETE]</h3>

<p>An <code class="prettyprint">Authorization</code> header is required to identify the user who sent the request.</p>

<ul>
<li><p>Parameters</p>

<ul>
<li>id: &ldquo;77&rdquo; (required, string) - User ID of the user to whom the request is addressed to.</li>
</ul></li>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Accept: application/json
    Authorization: Bearer {JWT_TOKEN}</p></li>
</ul></li>
<li><p>Response 200 (text/plain)</p>

<ul>
<li><p>Body</p>

<p>Ok</p></li>
</ul></li>
</ul>

<h2 id="accept-friend-request-friend_requests-from-accept">Accept Friend Request [/friend_requests/{from}/accept]</h2>

<p>For accepting a friend request.</p>

<h3 id="accept-a-friend-request-put">Accept a Friend Request [PUT]</h3>

<p>Deleting a friend request and creates a friend resource in its place. The user accepting the friend request is identified through the <code class="prettyprint">Authorization</code> header. You can only accept a friend request once.</p>

<ul>
<li><p>Parameters</p>

<ul>
<li>from: &ldquo;77&rdquo; (required, string) - User ID of the user who sent the request.</li>
</ul></li>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Accept: application/json
    Authorization: Bearer {JWT_TOKEN}</p></li>
</ul></li>
<li><p>Response 200 (text/plain)</p>

<ul>
<li><p>Body</p>

<p>Ok</p></li>
</ul></li>
</ul>

<h2 id="refuse-friend-request-friend_requests-from-refuse">Refuse Friend Request [/friend_requests/{from}/refuse]</h2>

<p>For refusing a friend request.</p>

<h3 id="refuse-a-friend-request-delete">Refuse a Friend Request [DELETE]</h3>

<p>The user accepting the friend request is identified through the <code class="prettyprint">Authorization</code> header.</p>

<ul>
<li><p>Parameters</p>

<ul>
<li>from: &ldquo;77&rdquo; (required, string) - User ID of the user who sent the request.</li>
</ul></li>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Accept: application/json
    Authorization: Bearer {JWT_TOKEN}</p></li>
</ul></li>
<li><p>Response 200 (text/plain)</p>

<ul>
<li><p>Body</p>

<p>Ok</p></li>
</ul></li>
</ul>

<h2 id="all-friends-friends">All Friends [/friends]</h2>

<p>The friend resource represents a friendship between two (2) users. A friendship is only created when a friend request has been accepted by a user.</p>

<h3 id="fetch-all-friends-get">Fetch all Friends [GET]</h3>

<p>Get all friends of a user. The user is identified through the Authorization header provided.</p>

<ul>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Accept: application/json
    Authorization: Bearer {JWT_TOKEN}</p></li>
</ul></li>
<li><p>Response 200 (text/plain)</p>

<ul>
<li><p>Body</p>

<p>[
      {
        &ldquo;oauth_id&rdquo;: &ldquo;12&rdquo;
      }
    ]</p></li>
</ul></li>
</ul>

<h2 id="a-friend-friends-id">A friend [/friends/{id}]</h2>

<h3 id="delete-friendship-delete">Delete Friendship [DELETE]</h3>

<p>An id param is expected which identifies the current user&rsquo;s friend. The current user is identified through the Authorization header provided.</p>

<ul>
<li><p>Parameters</p>

<ul>
<li>id: &ldquo;77&rdquo; (required, string) - User ID of the user who is a friend of current user.</li>
</ul></li>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Accept: application/json
    Authorization: Bearer {JWT_TOKEN}</p></li>
</ul></li>
<li><p>Response 200 (text/plain)</p>

<ul>
<li><p>Body</p>

<p>Ok</p></li>
</ul></li>
</ul>

<h2 id="all-friends-for-services-private-friends">All Friends for Services [/private/friends]</h2>

<p>Friends resource meant to be accessed by other MTA services.</p>

<h3 id="fetch-all-friends-get">Fetch all Friends [GET]</h3>

<p>Get all friends of a user. The user is identified through the <code class="prettyprint">id</code> query parameter.
<code class="prettyprint">AUTH_CODE</code> is the Base64-encoded, sha256 hash of a secret key shared across services and the url of the endpoint.</p>

<ul>
<li><p>Parameters</p>

<ul>
<li>id: &ldquo;77&rdquo; (required, string) - User ID of the user who you want to fetch friends for.</li>
</ul></li>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Accept: application/json
    Authorization: X-C51 {JWT_TOKEN}</p></li>
</ul></li>
<li><p>Response 200 (text/plain)</p>

<ul>
<li><p>Body</p>

<p>true/false</p></li>
</ul></li>
</ul>

<h2 id="friendship-check-for-users-friends-with-id">Friendship Check for Users [/friends-with/{id}]</h2>

<h3 id="check-if-two-2-users-are-connected-get">Check if Two (2) Users are Connected [GET]</h3>

<p>The current user is identified through the Authorization header provided.</p>

<ul>
<li><p>Parameters</p>

<ul>
<li>id: &ldquo;77&rdquo; (required, string) - User ID</li>
</ul></li>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Authorization: Bearer {AUTH_CODE}</p></li>
</ul></li>
<li><p>Response 200 (text/plain)</p>

<ul>
<li><p>Body</p>

<p>true/false</p></li>
</ul></li>
</ul>

<h2 id="friendship-check-for-services-private-friends-with">Friendship Check for Services [/private/friends-with]</h2>

<h3 id="check-if-two-2-users-are-connected-get">Check if Two (2) Users are Connected [GET]</h3>

<p><code class="prettyprint">AUTH_CODE</code> is the Base64-encoded, sha256 hash of a secret key shared across services and the url of the endpoint.</p>

<ul>
<li><p>Parameters</p>

<ul>
<li>id: &ldquo;77&rdquo; (required, string) - User ID</li>
<li>friend_id: &ldquo;78&rdquo; (required, string) - User ID</li>
</ul></li>
<li><p>Request</p>

<ul>
<li><p>Headers</p>

<p>Authorization: X-C51 {AUTH_CODE}</p></li>
</ul></li>
<li><p>Response 200 (text/plain)</p>

<ul>
<li><p>Body</p>

<p>true/false</p></li>
</ul></li>
</ul>

<h1 id="authentication-amp-authorization">Authentication &amp; Authorization</h1>

<h2 id="introduction">Introduction</h2>

<p>All services share a secret key</p>

<h2 id="scenario-1-authentication-authorization-between-services">Scenario 1 - Authentication/Authorization between services</h2>

<ol>
<li><p>Service <strong>A</strong> calls Service <strong>B</strong> (example: <code class="prettyprint">http://foo.orbita.com/api/v1/users</code>)</p></li>
<li><p>Service <strong>A</strong> takes Service <strong>B</strong> URL (<code class="prettyprint">http://foo.orbita.com/api/v1/users</code>) and encrypt it with SHA-256 using the shared key, encode it in base64 and put the resulting token in an header (example: <code class="prettyprint">Authorization: X-C51 xxxxxxxxxxxx</code>).</p></li>
<li><p>Service <strong>B</strong> receives the call, checks if the header is present and do the same process of point 2. Than Service <strong>B</strong> checks if both token are equal and only in this case it responds with the requested resource.</p></li>
</ol>

<p>If you want to try it in your shell, given <code class="prettyprint">$URL</code> as the URL of the resource that needs authentication and given <code class="prettyprint">$SECRET</code> the shared key:
<code class="prettyprint">shell
$ curl -vvv $URL -H &#39;Accept: application/json&#39; -H &quot;Authorization: X-C51 `echo -n $URL | openssl dgst -sha256 -hex -hmac $SECRET | cut -d &#39; &#39; -f 2`&quot;
</code></p>

<h2 id="scenario-2-authentication-authorization-between-apps-and-services">Scenario 2 - Authentication/Authorization between apps and services</h2>

<p><strong>Login Process</strong></p>

<ol>
<li>Application <strong>A</strong> calls <strong>orbita-oauth</strong> requesting a standard <em>OAuth 2.0</em> login process.</li>
<li><strong>orbita-oauth</strong> responds back with a <strong>access token</strong> (in jwt format) containing this data:</li>
</ol>
<pre class="highlight javascript"><code>          <span class="p">{</span>
            <span class="nl">user</span><span class="p">:</span> <span class="p">{</span>
              <span class="nl">id</span><span class="p">:</span> <span class="s1">'xxxxxxxxxxx'</span><span class="p">,</span>
              <span class="nx">email</span><span class="err">:</span> <span class="s1">'xxxxxxxxxxx'</span><span class="p">,</span>
              <span class="nx">expiration_date</span><span class="err">:</span> <span class="s1">'xxxxxxxxxxx'</span><span class="p">,</span>
              <span class="nx">date</span><span class="err">:</span> <span class="s1">'xxxxxxxxxxx'</span>
            <span class="p">}</span>
          <span class="p">}</span>
</code></pre>

<p>and a <strong>refresh_token</strong>.</p>

<ol>
<li>If Application <strong>A</strong> is an internal Orbita app it creates a cookie to share both tokens with <strong>orbita-components</strong>.</li>
<li>If Application <strong>A</strong> find that a cookie is already present it simply calls <strong>orbita-oauth</strong> to verify if the token is still valid. If the token is not valid Application <strong>A</strong> uses the <code class="prettyprint">refresh_token</code> to request to <strong>orbita-oauth</strong> another valid token.</li>
</ol>

<p><strong>Resource Request Process</strong></p>

<ol>
<li>Application <strong>A</strong> calls Service <strong>B</strong> (example: <code class="prettyprint">http://foo.orbita.com/api/v1/users</code>) and include the jwt token in the header <code class="prettyprint">Authorization: Bearer xxxxxxxxxxxxxx</code></li>
<li>Service <strong>B</strong> calls <strong>orbita-oauth</strong> and check if the token is valid. If it&rsquo;s valid it responds with the requested resource</li>
</ol>

<h2 id="general-considerations">General Considerations</h2>

<p>In general keep in mind that:</p>

<ul>
<li>services should be able to ask each other almost every kind of information (example: complete orbita users list)</li>
<li>apps should be able to ask to services <strong>only informations about the logged user</strong> (example: his own friends list, his own notifications, etc)</li>
</ul>

<h1 id="orbita-components-api">Orbita Components API</h1>

<h3 id="setup">Setup</h3>

<ol>
<li>Add to your html file next scripts:

<ul>
<li><code class="prettyprint">&lt;script src=&quot;&lt;%= Rails.application.secrets.cdn_url %&gt;/orbita_components.js&quot;&gt;&lt;/script&gt;</code></li>
<li><code class="prettyprint">&lt;script src=&quot;https://cdn.polyfill.io/v2/polyfill.js?features=Intl.~locale.en&quot;&gt;&lt;/script&gt;</code></li>
<li><code class="prettyprint">&lt;script src=&quot;https://cdn.polyfill.io/v2/polyfill.js?features=Intl.~locale.it&quot;&gt;&lt;/script&gt;</code></li>
</ul></li>
<li>Add styles:

<ul>
<li><code class="prettyprint">&lt;link href=&quot;&lt;%= Rails.application.secrets.cdn_url %&gt;/orbita_components.css&quot; rel=&quot;stylesheet&quot;&gt;</code></li>
</ul></li>
</ol>

<h3 id="api">API</h3>

<ul>
<li><code class="prettyprint">orbitaComponents.init</code> renders components with params.</li>
<li><code class="prettyprint">orbitaComponents.showFlashMessage</code> shows a flash message with the following params.

<ul>
<li><code class="prettyprint">text</code>: the text of the messagge</li>
<li><code class="prettyprint">cssClass</code>: the css class applied to the message (<code class="prettyprint">info</code>, <code class="prettyprint">warning</code>, <code class="prettyprint">danger</code>)</li>
<li><code class="prettyprint">duration</code>: the flash message display time in ms.</li>
</ul></li>
</ul>

<p>example: <code class="prettyprint">orbitaComponents.showFlashMessage(&#39;lorem ipsum&#39;, &#39;info&#39;, 2500)</code></p>

<h3 id="example">Example:</h3>
<pre class="highlight javascript"><code><span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"orbita_toolbar_wrapper"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>
<span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"orbita_body"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>
<span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"orbita_footer"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span><span class="nx">orbitaComponents</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span>
  <span class="na">toolbar</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">wrapperId</span><span class="p">:</span> <span class="s1">'orbita_toolbar_wrapper'</span><span class="p">,</span> <span class="na">links</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="na">url</span><span class="p">:</span> <span class="s1">'https://foo.com'</span><span class="p">,</span>
        <span class="na">it</span><span class="p">:</span> <span class="s1">'Foo IT'</span><span class="p">,</span>
        <span class="na">en</span><span class="p">:</span> <span class="s1">'Foo EN'</span>
      <span class="p">},{</span>
        <span class="na">url</span><span class="p">:</span> <span class="s1">'http://boo.com'</span><span class="p">,</span>
        <span class="na">it</span><span class="p">:</span> <span class="s1">'Boo IT'</span><span class="p">,</span>
        <span class="na">en</span><span class="p">:</span> <span class="s1">'Boo EN'</span>
      <span class="p">}],</span>
      <span class="na">logoImage</span><span class="p">:</span> <span class="s2">"&lt;%=asset_url('white_logo.png') %&gt;"</span><span class="p">,</span>
      <span class="na">logoWidth</span><span class="p">:</span> <span class="s2">"165px"</span><span class="p">,</span>
      <span class="na">logoHeight</span><span class="p">:</span> <span class="s2">"36px"</span>
  <span class="p">},</span>
  <span class="na">footer</span><span class="p">:</span> <span class="p">{</span><span class="na">wrapperId</span><span class="p">:</span> <span class="s1">'orbita_footer'</span><span class="p">}</span>
<span class="p">});</span>
</code></pre>

<h3 id="different-links-in-toolbar-you-can-provide-function-for-customize-links">Different links in toolbar - you can provide function for customize links:</h3>
<pre class="highlight javascript"><code><span class="nx">orbitaComponents</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span>
  <span class="na">toolbar</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">wrapperId</span><span class="p">:</span> <span class="s1">'orbita_toolbar_wrapper'</span><span class="p">,</span> <span class="na">links</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="na">url</span><span class="p">:</span> <span class="s1">'https://foo.com'</span><span class="p">,</span>
        <span class="na">it</span><span class="p">:</span> <span class="s1">'Foo IT'</span><span class="p">,</span>
        <span class="na">en</span><span class="p">:</span> <span class="s1">'Foo EN'</span>
      <span class="p">},{</span>
        <span class="na">url</span><span class="p">:</span> <span class="s1">'http://boo.com'</span><span class="p">,</span>
        <span class="na">it</span><span class="p">:</span> <span class="s1">'Boo IT'</span><span class="p">,</span>
        <span class="na">en</span><span class="p">:</span> <span class="s1">'Boo EN'</span>
      <span class="p">},</span> <span class="p">{</span>
        <span class="na">url</span><span class="p">:</span> <span class="s1">'/settings'</span><span class="p">,</span>
        <span class="na">it</span><span class="p">:</span> <span class="s1">'Settings'</span><span class="p">,</span>
        <span class="na">en</span><span class="p">:</span> <span class="s1">'Settings'</span><span class="p">,</span>
        <span class="na">authorization</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">currentUser</span><span class="p">){</span> <span class="k">return</span> <span class="nx">currentUser</span> <span class="p">}</span>
      <span class="p">}],</span>
      <span class="na">logoImage</span><span class="p">:</span> <span class="s2">"&lt;%=asset_url('white_logo.png') %&gt;"</span><span class="p">,</span>
      <span class="na">logoWidth</span><span class="p">:</span> <span class="s2">"165px"</span><span class="p">,</span>
      <span class="na">logoHeight</span><span class="p">:</span> <span class="s2">"36px"</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>

<h3 id="example-with-friend-button">Example with Friend Button</h3>
<pre class="highlight javascript"><code> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
   <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Alex</span> <span class="nx">Err</span> <span class="kd">with</span> <span class="nx">id</span> <span class="mi">2</span><span class="o">&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>   <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"button_connect"</span><span class="o">&gt;&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span> <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span> <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"text/javascript"</span> <span class="nx">charset</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="o">&gt;</span>
   <span class="nx">orbitaComponents</span><span class="p">.</span><span class="nx">renderFriendshipButton</span><span class="p">({</span><span class="na">wrapperId</span><span class="p">:</span> <span class="s1">'button_connect'</span><span class="p">,</span> <span class="na">userId</span><span class="p">:</span> <span class="mi">2</span><span class="p">});</span>
<span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre>

<h3 id="adding-custom-links-to-user-menu-in-the-toolbar">Adding custom links to user menu in the toolbar</h3>
<pre class="highlight javascript"><code><span class="nx">orbitaComponents</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span>
  <span class="na">toolbar</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">userMenu</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">links</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="na">url</span><span class="p">:</span> <span class="s1">'http://www.facebook.com'</span><span class="p">,</span>
          <span class="na">it</span><span class="p">:</span> <span class="s1">'Faccebooke'</span><span class="p">,</span>
          <span class="na">en</span><span class="p">:</span> <span class="s1">'Facebook'</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre>

<ul>
<li>The above example adds a link under the user menu.</li>
</ul>

<h1 id="verify-jwt-token">Verify JWT Token</h1>

<ul>
<li>URL: <code class="prettyprint">http://OAUTH-DOMAIN/api/v1/jwt/verify</code></li>
<li>Type: <code class="prettyprint">GET</code></li>
<li>Format: <code class="prettyprint">json</code></li>
<li>PARAMS:

<ul>
<li><code class="prettyprint">jwt_token</code>(string)</li>
</ul></li>
<li>Return json:

<ul>
<li><code class="prettyprint">id</code>(uuid) - user id</li>
<li><code class="prettyprint">email</code>(string) - user email</li>
<li><code class="prettyprint">first_name</code>(string) - user first name</li>
<li><code class="prettyprint">last_name</code>(string) - user last name</li>
</ul></li>
<li>Statuses:

<ul>
<li><code class="prettyprint">401</code> - if token invalid</li>
<li><code class="prettyprint">200</code> - if token valid</li>
</ul></li>
</ul>

<h2 id="metadata">Metadata</h2>

<p>Every domain event will have the same metadata
* <code class="prettyprint">id</code> (<code class="prettyprint">UUID</code>): an <code class="prettyprint">UUID</code> generated by the service that emitted the event
* <code class="prettyprint">type</code> (<code class="prettyprint">string</code>): the type of the event
* <code class="prettyprint">source</code> (<code class="prettyprint">string</code>): the name of the service that emitted the event
* <code class="prettyprint">emitted_at</code> (<code class="prettyprint">datetime</code>): the time at which the event is emitted
* <code class="prettyprint">correlation_id</code> (<code class="prettyprint">string</code>): an id that can be used to create relationship between events (ex. If I group friendship events using the <code class="prettyprint">correlation_id</code> I will expect to see groups of events like [<code class="prettyprint">FriendshipRequested</code>, <code class="prettyprint">FriendshipAccepted</code>] or [<code class="prettyprint">FriendshipRequested</code>, <code class="prettyprint">FriendshipRefused</code>])
* <code class="prettyprint">payload</code> (<code class="prettyprint">object</code>): event specific data</p>

<h1 id="domain-events">Domain Events</h1>

<h2 id="friendshiprequested">FriendshipRequested</h2>

<p>Emitted on channel <code class="prettyprint">orbita-networking</code></p>

<p>Emitted from the orbita-networking service when a user requests friendship from another user
* <code class="prettyprint">from</code> (<code class="prettyprint">UUID</code>): the <code class="prettyprint">OAUTH</code> id of the user that requested the friendship
* <code class="prettyprint">to</code> (<code class="prettyprint">UUID</code>): the <code class="prettyprint">OAUTH</code> id of the target user</p>

<p>Example:
<code class="prettyprint">javascript
{
  &quot;id&quot;: &quot;95494570-BA22-488E-AF9A-E272589ACEA2&quot;,
  &quot;type&quot;: &quot;FriendshipRequested&quot;,
  &quot;source&quot;: &quot;networking&quot;,
  &quot;emitted_at&quot;: &quot;2015-09-17T13:55:02.930Z&quot;,
  &quot;correlation_id&quot;: &quot;80F2564A-0B14-4731-BF6A-B7D3CAA61E48&quot;,
  &quot;payload&quot;: {
    &quot;from&quot;: &quot;C3B499C8-7F7F-45D0-82D7-75BFFF7417FD&quot;,
    &quot;to&quot;: &quot;5B5A541F-2E16-4DAA-9AA5-710EDF09E6E4&quot;
  }
}
</code></p>

<h2 id="friendshipaccepted">FriendshipAccepted</h2>

<p>Emitted on channel <code class="prettyprint">orbita-networking</code></p>

<p>Emitted from the orbita-networking service when a friendship request has been accepted by a user.
* <code class="prettyprint">from</code> (<code class="prettyprint">UUID</code>): the <code class="prettyprint">OAUTH</code> id of the user that requested the friendship
* <code class="prettyprint">to</code> (<code class="prettyprint">UUID</code>): the <code class="prettyprint">OAUTH</code> id of the target user
* <code class="prettyprint">request_id</code> : the id of the friend request</p>

<h2 id="friendshiprefused">FriendshipRefused</h2>

<p>Emitted on channel <code class="prettyprint">orbita-networking</code></p>

<p>Emitted from the orbita-networking service when a friendship request has been refused by a user.
* <code class="prettyprint">from</code> (<code class="prettyprint">UUID</code>): the <code class="prettyprint">OAUTH</code> id of the user that requested the friendship
* <code class="prettyprint">to</code> (<code class="prettyprint">UUID</code>): the <code class="prettyprint">OAUTH</code> id of the target user
* <code class="prettyprint">request_id</code> : the id of the friend request</p>

<h2 id="usercreated">UserCreated</h2>

<p>Emitted on channel <code class="prettyprint">orbita-oauth</code></p>

<ul>
<li><code class="prettyprint">id</code> (<code class="prettyprint">UUID</code>): an <code class="prettyprint">UUID</code> generated by the service that emitted the event</li>
<li><code class="prettyprint">type</code> (<code class="prettyprint">string</code>): the type of the event</li>
<li><code class="prettyprint">source</code> (<code class="prettyprint">string</code>): the name of the service that emitted the event</li>
<li><code class="prettyprint">emitted_at</code> (<code class="prettyprint">datetime</code>): the time at which the event is emitted</li>
<li><code class="prettyprint">payload</code> -&gt; user private profile fields</li>
</ul>

<p>Example:
&ldquo;`javascript</p>

<p>{
  &quot;id&rdquo;: &ldquo;95494570-BA22-488E-AF9A-E272589ACEA2&rdquo;,
  &ldquo;type&rdquo;: &ldquo;UserCreated&rdquo;,
  &ldquo;source&rdquo;: &ldquo;orbita-oauth&rdquo;,
  &ldquo;emitted_at&rdquo;: &ldquo;2015-09-17T13:55:02.930Z&rdquo;,
  &ldquo;payload&rdquo;: {
    user: {
      id: 1,
      email: &lsquo;example@mail.com&rsquo;,
      first_name: &#39;first&rsquo;,
      last_name: &#39;last&rsquo;
    }
  }
}
&ldquo;`</p>

<h2 id="userupdated">UserUpdated</h2>

<p>Emitted on channel <code class="prettyprint">orbita-oauth</code></p>

<ul>
<li><code class="prettyprint">id</code> (<code class="prettyprint">UUID</code>): an <code class="prettyprint">UUID</code> generated by the service that emitted the event</li>
<li><code class="prettyprint">type</code> (<code class="prettyprint">string</code>): the type of the event</li>
<li><code class="prettyprint">source</code> (<code class="prettyprint">string</code>): the name of the service that emitted the event</li>
<li><code class="prettyprint">emitted_at</code> (<code class="prettyprint">datetime</code>): the time at which the event is emitted</li>
<li><code class="prettyprint">payload</code> -&gt; user private profile fields</li>
</ul>

<p>Example:
&rdquo;`javascript</p>

<p>{
  &ldquo;id&rdquo;: &ldquo;95494570-BA22-488E-AF9A-E272589ACEA2&rdquo;,
  &ldquo;type&rdquo;: &ldquo;UserUpdated&rdquo;,
  &ldquo;source&rdquo;: &ldquo;orbita-oauth&rdquo;,
  &ldquo;emitted_at&rdquo;: &ldquo;2015-09-17T13:55:02.930Z&rdquo;,
  &ldquo;payload&rdquo;: {
    user: {
      id: 1,
      email: &#39;example@mail.com&rsquo;,
      first_name: &#39;first&rsquo;,
      last_name: &#39;last&rsquo;
    }
  }
}
&ldquo;`</p>

<h2 id="user-language-changed">User language changed</h2>

<p>Emitted on channel <code class="prettyprint">orbita-oauth</code></p>

<ul>
<li><code class="prettyprint">id</code> (<code class="prettyprint">UUID</code>): an <code class="prettyprint">UUID</code> generated by the service that emitted the event</li>
<li><code class="prettyprint">type</code> (<code class="prettyprint">string</code>): the type of the event</li>
<li><code class="prettyprint">source</code> (<code class="prettyprint">string</code>): the name of the service that emitted the event</li>
<li><code class="prettyprint">emitted_at</code> (<code class="prettyprint">datetime</code>): the time at which the event is emitted</li>
<li><code class="prettyprint">payload</code> -&gt; <code class="prettyprint">{from: &#39;en&#39;, to: &#39;it&#39;, user_id: 1}</code></li>
</ul>

<p>Example:
&rdquo;`javascript</p>

<p>{
  &ldquo;id&rdquo;: &ldquo;95494570-BA22-488E-AF9A-E272589ACEA2&rdquo;,
  &ldquo;type&rdquo;: &ldquo;UserLanguageChanged&rdquo;,
  &ldquo;source&rdquo;: &ldquo;orbita-oauth&rdquo;,
  &ldquo;emitted_at&rdquo;: &ldquo;2015-09-17T13:55:02.930Z&rdquo;,
  &ldquo;payload&rdquo;: {
    &ldquo;user_id&rdquo;: 1,
    &ldquo;from&rdquo;: &ldquo;en&rdquo;,
    &ldquo;to&rdquo;: &ldquo;it&rdquo;
  }
}
&ldquo;`</p>

<h2 id="userdeleted">UserDeleted</h2>

<p>Emitted on channel <code class="prettyprint">orbita-oauth</code></p>

<ul>
<li><code class="prettyprint">id</code> (<code class="prettyprint">UUID</code>): an <code class="prettyprint">UUID</code> generated by the service that emitted the event</li>
<li><code class="prettyprint">type</code> (<code class="prettyprint">string</code>): the type of the event</li>
<li><code class="prettyprint">source</code> (<code class="prettyprint">string</code>): the name of the service that emitted the event</li>
<li><code class="prettyprint">emitted_at</code> (<code class="prettyprint">datetime</code>): the time at which the event is emitted</li>
<li><code class="prettyprint">payload</code> -&gt; <code class="prettyprint">{user_id: 1}</code></li>
</ul>

<p>Example:
<code class="prettyprint">javascript
{
  &quot;id&quot;: &quot;95494570-BA22-488E-AF9A-E272589ACEA2&quot;,
  &quot;type&quot;: &quot;UserDeleted&quot;,
  &quot;source&quot;: &quot;orbita-oauth&quot;,
  &quot;emitted_at&quot;: &quot;2015-09-17T13:55:02.930Z&quot;,
  &quot;payload&quot;: {
    &quot;user_id&quot;: 1,
  }
}
</code></p>

<h2 id="userlogout">UserLogout</h2>

<ul>
<li><code class="prettyprint">id</code> (<code class="prettyprint">UUID</code>): an <code class="prettyprint">UUID</code> generated by the service that emitted the event</li>
<li><code class="prettyprint">type</code> (<code class="prettyprint">string</code>): the type of the event</li>
<li><code class="prettyprint">source</code> (<code class="prettyprint">string</code>): the name of the service that emitted the event</li>
<li><code class="prettyprint">emitted_at</code> (<code class="prettyprint">datetime</code>): the time at which the event is emitted</li>
<li><code class="prettyprint">payload</code> -&gt; <code class="prettyprint">{user_id: 1}</code></li>
</ul>

<p>Example:
<code class="prettyprint">javascript
{
  &quot;id&quot;: &quot;95494570-BA22-488E-AF9A-E272589ACEA2&quot;,
  &quot;type&quot;: &quot;UserDeleted&quot;,
  &quot;source&quot;: &quot;orbita-oauth&quot;,
  &quot;emitted_at&quot;: &quot;2015-09-17T13:55:02.930Z&quot;,
  &quot;payload&quot;: {
    &quot;user_id&quot;: 1,
  }
}
</code></p>

<h2 id="artworkshared">ArtworkShared</h2>

<p>Emitted on channel <code class="prettyprint">inventory</code></p>

<ul>
<li><code class="prettyprint">id</code> (<code class="prettyprint">UUID</code>): an <code class="prettyprint">UUID</code> generated by the service that emitted the event</li>
<li><code class="prettyprint">type</code> (<code class="prettyprint">string</code>): <code class="prettyprint">ArtworkShared</code></li>
<li><code class="prettyprint">source</code> (<code class="prettyprint">string</code>): <code class="prettyprint">inventory</code></li>
<li><code class="prettyprint">emitted_at</code> (<code class="prettyprint">datetime</code>): the time at which the event is emitted</li>
<li><code class="prettyprint">correlation_id</code> (<code class="prettyprint">UUID</code>): an id that can be used to correlate events. This is responsibility of the emitting service</li>
<li><code class="prettyprint">payload</code>:

<ul>
<li><code class="prettyprint">artwork_id</code> (<code class="prettyprint">UUID</code>): the artwork identifier to be used to eventually retrieve informations about the artworks</li>
<li><code class="prettyprint">artwork_title</code> (<code class="prettyprint">string</code>): the artwork&rsquo;s title</li>
<li><code class="prettyprint">artwork_author</code> (<code class="prettyprint">string</code>): the artwork&rsquo;s author</li>
<li><code class="prettyprint">from</code> (<code class="prettyprint">UUID</code>): the <code class="prettyprint">OAUTH</code> id of the user that shared the artwork</li>
<li><code class="prettyprint">to</code> (<code class="prettyprint">UUID</code>): the <code class="prettyprint">OAUTH</code> id of the target user</li>
</ul></li>
</ul>

<p>Example:
<code class="prettyprint">javascript
{
  &quot;id&quot;: &quot;95494570-BA22-488E-AF9A-E272589ACEA2&quot;,
  &quot;type&quot;: &quot;ArtworkShared&quot;,
  &quot;source&quot;: &quot;inventory&quot;,
  &quot;emitted_at&quot;: &quot;2015-09-17T13:55:02.930Z&quot;,
  &quot;payload&quot;: {
    &quot;artwork_id&quot;: &quot;49b530f6-35c6-4d26-af22-fd67f594bd98&quot;,
    &quot;artwork_title&quot;: &quot;Mona Lisa&quot;,
    &quot;artwork_author&quot;: &quot;Leonardo da Vinci&quot;,
    &quot;from&quot;: &quot;C3B499C8-7F7F-45D0-82D7-75BFFF7417FD&quot;,
    &quot;to&quot;: &quot;5B5A541F-2E16-4DAA-9AA5-710EDF09E6E4&quot;
  }
}
</code></p>

<ol>
<li>Oauth service must be run on <code class="prettyprint">5100</code></li>
<li>JWT-Test app must be run on <code class="prettyprint">3000</code></li>
<li>Network app must be run on <code class="prettyprint">4001</code></li>
<li>Components must be run (webpack) on <code class="prettyprint">8080</code></li>
</ol>

<h2 id="mta-oauth-create-apps">Mta-Oauth create apps</h2>

<ul>
<li><code class="prettyprint">rake db:seed</code></li>
<li>create via rails c an admin user (get a user from User.first and se is_admin to true)</li>
<li>Open localhost:5100, login with admin user</li>
<li>Go to admin section, and create first application, add callback urls. (mark <code class="prettyprint">trusted</code> as true)</li>
</ul>

<p>Example:</p>
<pre class="highlight javascript"><code>  <span class="nx">Redirect</span> <span class="nx">uri</span><span class="err">:</span> <span class="s2">"http://portal.mysite-staging.com/users/auth/oauth51/callback"</span><span class="p">,</span>
  <span class="nx">Uid</span><span class="err">:</span> <span class="s2">"dc58bccd82602fa1c86bdff342e3c627d44dd642dabf2e9b645ea0e501291d14"</span><span class="p">,</span>
  <span class="nx">Secret</span><span class="err">:</span> <span class="s2">"a19c7a77185df47182dbe241a9e02614465da2dfe8f06d7fe888645465312001"</span>
</code></pre>

<p>Then go to your application (jwt_test, developers) and add this secret and id to secret.yml</p>

<h1 id="how-to-create-new-application-and-use-all-orbita-services">How to create new application and use all orbita services</h1>

<h3 id="create-new-rails-app">Create new rails app</h3>

<ul>
<li><code class="prettyprint">rails new orbita_example &amp;&amp; cd orbita_example</code></li>
<li><p>add to Gemfile auth gems:</p>

<ul>
<li><code class="prettyprint">gem &#39;omniauth-oauth51&#39;, git: &#39;https://github.com/coders51/omniauth-oauth51.git&#39;</code></li>
<li><code class="prettyprint">gem &#39;oauth51-client&#39;, git: &#39;https://github.com/coders51/oauth51-client.git&#39;</code></li>
</ul></li>
<li><p><code class="prettyprint">bundle install</code></p></li>
<li><p>Create oauth application in oauth app.</p>

<ul>
<li>Login  into <code class="prettyprint">connect.mysite-staging.com as admin</code> and go to <code class="prettyprint">Dashboard</code></li>
<li>Navigate to <code class="prettyprint">Application</code> and click <code class="prettyprint">Add new</code></li>
<li>Fill into: name <code class="prettyprint">application name</code>, Redirect uri <code class="prettyprint">http://my-site.mysite.com/users/auth/oauth51/callback</code>, Trusted <code class="prettyprint">true</code></li>
<li>Click <code class="prettyprint">Save</code> button</li>
<li>Go to your application and open <code class="prettyprint">config/secrets.yml</code> (also put to <code class="prettyprint">.gitignore</code> this file)</li>
<li>Add your application secret code and uid to this file, example:
*
<code class="prettyprint">ruby
oauth:
client_id: 0e08f9a0d80790d1d945fabfb4a80987fb17a5ac0a423448f8dc318e141f0d0e
client_secret: 657a4c196c50ec957804c87d3915ad5b1f0504def89682b5d50131f4e72df766
app_url: http://localhost:5100
</code></li>
</ul></li>
</ul>

<h2 id="how-to-compose-your-secret-yml-file">How to compose your secret.yml file</h2>

<ul>
<li><p>Rails.application.secrets.jwt_cookie - This is the name of the browser cookie where the JWT token will be stored. We use JWT for authentication. This must be the same for all services that will communicate with each other. For example, all orbita services in production must have the same cookie. The cookie used for orbita services in production must be different from the cookie used for orbita services in staging.</p></li>
<li><p>Rails.application.secrets.cdn_url - This is the url for the components/cdn service. For example, orbita staging’s cdn service is at http://cdn-staging.getorbita.io while orbita production’s cdn service is at http://cdn.getorbita.io.</p></li>
<li><p>Rails.application.secrets.amqp - We are expected to set 3 variables here which are vhost, username and password. Setting a virtual_host is a way for us to ensure that orbita services for staging do not mix up RabbitMQ messages with orbita services for production. We run one instance of RabbitMQ which is shared by multiple deployments. These details must be the same for services that will communicate with each other.</p></li>
<li><p>Rails.application.secrets.oauth[&#39;client_id’] - In the oauth service, we’ll need to add the application. Once added, we’ll have oauth credentials for both client_id and client_secret. If I remember correctly, API key is client_id.</p></li>
<li><p>Rails.application.secrets.oauth[&#39;client_secret’] - In the oauth service, we’ll need to add the application. Once added, we’ll have oauth credentials for both client_id and client_secret.</p></li>
<li><p>Rails.application.secrets.oauth[&#39;app_url’] - This is the url for the oauth service. For example, in staging for orbita, it would be http://connect-staging.getorbita.io. For development, it would be something like http://localhost:5100. For production, it would be http://connect.getorbita.io.</p></li>
</ul>

<h3 id="login-section">Login section</h3>

<p>For login, you can use oauth provider, and implement it in your application. Let&rsquo;s do it:
 * Add to <code class="prettyprint">devise.rb</code>:</p>
<pre class="highlight javascript"><code><span class="nx">config</span><span class="p">.</span><span class="nx">omniauth</span> <span class="err">:</span><span class="nx">oauth51</span><span class="p">,</span> <span class="nx">Rails</span><span class="p">.</span><span class="nx">application</span><span class="p">.</span><span class="nx">secrets</span><span class="p">.</span><span class="nx">oauth</span><span class="p">[</span><span class="s1">'client_id'</span><span class="p">],</span>   <span class="nx">Rails</span><span class="p">.</span><span class="nx">application</span><span class="p">.</span><span class="nx">secrets</span><span class="p">.</span><span class="nx">oauth</span><span class="p">[</span><span class="s1">'client_secret'</span><span class="p">],</span> <span class="nx">scope</span><span class="err">:</span> <span class="s1">'public accounts points'</span><span class="p">,</span> <span class="nx">client_options</span><span class="err">:</span> <span class="p">{</span><span class="nl">site</span><span class="p">:</span> <span class="nx">Rails</span><span class="p">.</span><span class="nx">application</span><span class="p">.</span><span class="nx">secrets</span><span class="p">.</span><span class="nx">oauth</span><span class="p">[</span><span class="s1">'app_url'</span><span class="p">]}</span>

</code></pre>

<ul>
<li>Create <code class="prettyprint">omniauth_callbacks_controller.rb</code> in <code class="prettyprint">app/controllers</code> folder:</li>
</ul>
<pre class="highlight ruby"><code>  <span class="k">class</span> <span class="nc">OmniauthCallbacksController</span> <span class="o">&lt;</span> <span class="no">Devise</span><span class="o">::</span><span class="no">OmniauthCallbacksController</span>

    <span class="no">COOKIES_KEY</span> <span class="o">=</span> <span class="ss">:_jwt_token</span>
    <span class="no">COOKIES_REFRESH_KEY</span> <span class="o">=</span> <span class="ss">:_refresh_token</span>

    <span class="k">def</span> <span class="nf">oauth51</span>
      <span class="n">o51_authentication_token</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">env</span><span class="p">[</span><span class="s2">"omniauth.auth"</span><span class="p">].</span><span class="nf">credentials</span><span class="p">.</span><span class="nf">token</span>
      <span class="n">o51_refresh_token</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">env</span><span class="p">[</span><span class="s2">"omniauth.auth"</span><span class="p">].</span><span class="nf">credentials</span><span class="p">.</span><span class="nf">refresh_token</span>

      <span class="c1">### We need set token to cookies, then all apps can use it for login user.</span>
      <span class="n">set_auth_cookies</span><span class="p">(</span><span class="n">o51_authentication_token</span><span class="p">,</span> <span class="n">o51_refresh_token</span><span class="p">)</span>
      <span class="n">client</span> <span class="o">=</span> <span class="no">Oauth51Client</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">o51_authentication_token</span><span class="p">,</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secrets</span><span class="p">.</span><span class="nf">oauth</span><span class="p">[</span><span class="s1">'app_url'</span><span class="p">])</span>
      <span class="n">client</span><span class="p">.</span><span class="nf">me</span> <span class="c1"># returns info about user</span>
      <span class="no">User</span><span class="p">.</span><span class="nf">create_from_o51</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="nf">me</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">set_auth_cookies</span><span class="p">(</span><span class="n">jwt_token</span><span class="p">,</span> <span class="n">refresh_token</span><span class="p">)</span>
      <span class="n">cookies</span><span class="p">[</span><span class="no">COOKIES_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="ss">value: </span><span class="n">jwt_token</span><span class="p">,</span>
        <span class="ss">expires: </span><span class="mi">7</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">from_now</span><span class="p">,</span>
        <span class="ss">domain: :all</span>
      <span class="p">}</span>
      <span class="n">cookies</span><span class="p">[</span><span class="no">COOKIES_REFRESH_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="ss">value: </span><span class="n">refresh_token</span><span class="p">,</span>
        <span class="ss">expires: </span><span class="mi">7</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">from_now</span><span class="p">,</span>
        <span class="ss">domain: :all</span>
      <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre>

<ul>
<li>Login user if cookie present (include this concern where you want check and login user by cookies)</li>
</ul>
<pre class="highlight ruby"><code>  <span class="k">module</span> <span class="nn">JwtLogin</span>
    <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="no">COOKIES_KEY</span> <span class="o">=</span> <span class="ss">:_jwt_token</span>
  <span class="no">COOKIES_REFRESH_KEY</span> <span class="o">=</span> <span class="ss">:_refresh_token</span>

  <span class="k">def</span> <span class="nf">login_with_jwt</span><span class="p">(</span><span class="n">tries</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">delete_cookies</span> <span class="k">if</span> <span class="n">tries</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="n">jwt_token</span> <span class="o">=</span> <span class="n">cookies</span><span class="p">[</span><span class="no">COOKIES_KEY</span><span class="p">]</span>
    <span class="n">url</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secrets</span><span class="p">.</span><span class="nf">oauth</span><span class="p">[</span><span class="s1">'app_url'</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"/api/v1/users/me"</span>
    <span class="k">begin</span>
      <span class="n">user_info</span> <span class="o">=</span> <span class="no">RestClient</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="p">{</span><span class="s1">'Authorization'</span> <span class="o">=&gt;</span> <span class="s2">"Bearer </span><span class="si">#{</span><span class="n">jwt_token</span><span class="si">}</span><span class="s2">"</span><span class="p">})</span>
    <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/401/</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">unless</span> <span class="n">cookies</span><span class="p">[</span><span class="no">COOKIES_REFRESH_KEY</span><span class="p">]</span>
        <span class="n">refresh_token</span><span class="p">(</span><span class="n">cookies</span><span class="p">[</span><span class="no">COOKIES_REFRESH_KEY</span><span class="p">])</span>
        <span class="n">login_with_jwt</span><span class="p">(</span><span class="n">tries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="k">return</span> <span class="kp">nil</span>
    <span class="k">end</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">create_from_jwt_token</span><span class="p">(</span><span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">user_info</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">refresh_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">grant_type: </span><span class="s2">"refresh_token"</span><span class="p">,</span>
      <span class="ss">client_id: </span><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secrets</span><span class="p">.</span><span class="nf">oauth</span><span class="p">[</span><span class="s2">"client_id"</span><span class="p">],</span>
      <span class="ss">client_secret: </span><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secrets</span><span class="p">.</span><span class="nf">oauth</span><span class="p">[</span><span class="s2">"client_secret"</span><span class="p">],</span>
      <span class="ss">refresh_token: </span><span class="n">token</span>
    <span class="p">}</span>
    <span class="k">begin</span>
      <span class="n">token_data</span> <span class="o">=</span> <span class="no">RestClient</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secrets</span><span class="p">.</span><span class="nf">oauth</span><span class="p">[</span><span class="s2">"app_url"</span><span class="p">]</span> <span class="o">+</span> <span class="s1">'/oauth/token'</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="k">return</span> <span class="kp">nil</span>
    <span class="k">end</span>
    <span class="n">update_tokens</span><span class="p">(</span><span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">token_data</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update_tokens</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
    <span class="n">cookies</span><span class="p">[</span><span class="no">COOKIES_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">value: </span><span class="n">tokens</span><span class="p">[</span><span class="s2">"access_token"</span><span class="p">],</span>
      <span class="ss">expires: </span><span class="mi">7</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">from_now</span><span class="p">,</span>
      <span class="ss">domain: :all</span>
    <span class="p">}</span>
    <span class="n">cookies</span><span class="p">[</span><span class="no">COOKIES_REFRESH_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">value: </span><span class="n">tokens</span><span class="p">[</span><span class="s2">"refresh_token"</span><span class="p">],</span>
      <span class="ss">expires: </span><span class="mi">7</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">from_now</span><span class="p">,</span>
      <span class="ss">domain: :all</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">delete_cookies</span>
    <span class="n">cookies</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="no">COOKIES_KEY</span><span class="p">,</span> <span class="ss">domain: :all</span><span class="p">)</span>
    <span class="n">cookies</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="no">COOKIES_REFRESH_KEY</span><span class="p">,</span> <span class="ss">domain: :all</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<ul>
<li>Check if user token valid: Make request to oauth app <code class="prettyprint">/api/v1/users/me</code> with HEADERS: <code class="prettyprint">Authorization: &quot;Bearer #{token}&quot;</code></li>
</ul>

<h2 id="now-our-application-can-login-by-token-and-go-to-all-applications-as-logined-user">Now Our application can login by token, and go to all applications as logined user.</h2>

<p>Next step - add some components to our application. Lets add <code class="prettyprint">toolbar</code> with notifications:
 * Add to config/secrets.yml cdn url: <code class="prettyprint">cdn_url: http://cdn.mysite-staging.com</code>
 * Add to your layout next code:</p>
<pre class="highlight html"><code><span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"&lt;%= Rails.application.secrets.cdn_url %&gt;/orbita_components.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://cdn.polyfill.io/v2/polyfill.js?features=Intl.~locale.en"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://cdn.polyfill.io/v2/polyfill.js?features=Intl.~locale.it"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"&lt;%= Rails.application.secrets.cdn_url %&gt;/orbita_components.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/header&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"orbita_toolbar_wrapper"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"orbita_body"</span><span class="nt">&gt;</span>
  Here you can add your code..........
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"orbita_footer"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="kd">var</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">orbitaComponents</span><span class="p">.</span><span class="nx">configureStoreFunction</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">Reducers</span><span class="p">);</span>
    <span class="c1">//You can use store in your own redux application if you use react, or ignore it.</span>
    <span class="nx">orbitaComponents</span><span class="p">.</span><span class="nx">renderToolbar</span><span class="p">({</span><span class="na">wrapperId</span><span class="p">:</span> <span class="s1">'orbita_toolbar_wrapper'</span><span class="p">,</span> <span class="na">store</span><span class="p">:</span> <span class="nx">store</span><span class="p">,</span> <span class="na">links</span><span class="p">:</span> <span class="p">[{</span>
      <span class="na">url</span><span class="p">:</span> <span class="s1">'https://www.mysite.com/inventory/users/sign_in'</span><span class="p">,</span>
      <span class="na">it</span><span class="p">:</span> <span class="s1">'Inventario'</span><span class="p">,</span>
      <span class="na">en</span><span class="p">:</span> <span class="s1">'Inventory'</span>
    <span class="p">},{</span>
      <span class="na">url</span><span class="p">:</span> <span class="s1">'http://www.mysite.com'</span><span class="p">,</span>
      <span class="na">it</span><span class="p">:</span> <span class="s1">'Magazine'</span><span class="p">,</span>
      <span class="na">en</span><span class="p">:</span> <span class="s1">'Magazine'</span>
    <span class="p">}]});</span>
    <span class="nx">orbitaComponents</span><span class="p">.</span><span class="nx">renderFooter</span><span class="p">({</span><span class="na">wrapperId</span><span class="p">:</span> <span class="s1">'orbita_footer'</span><span class="p">,</span> <span class="na">store</span><span class="p">:</span> <span class="nx">store</span><span class="p">});</span>
  <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</code></pre>

<p><strong>It&rsquo;s all, enjoy!</strong></p>

<h1 id="how-to-store-user-data-in-orbita-bucket-service">How to Store User Data in Orbita Bucket Service</h1>

<p>We can store additional Orbita-specific user data in the Orbita Bucket service. To do this, we will need to send a request to Orbita Oauth which exposes the <code class="prettyprint">http://connect.getorbita.io/api/v1/users/1/bucket</code> endpoint. It works for the following methods:</p>

<ol>
<li><p>POST - replaces the user data stored in the bucket with the data passed along with the request. It expects a JSON-format body with a <code class="prettyprint">data</code> property like <code class="prettyprint">{&quot;data&quot;: {&quot;foo&quot;: &quot;bar&quot;}}</code>. Making a POST request to <code class="prettyprint">http://connect.getorbita.io/api/v1/users/1/bucket</code> with the above payload, will create a record with the following details <code class="prettyprint">{user_id: 1, data: {foo: &quot;bar&quot;}}</code>.</p></li>
<li><p>PUT - merges the <code class="prettyprint">data</code> payload with the data already stored for a specific user. If no previous user data exists, a new record will be created for that user. It expects a JSON-format body with a <code class="prettyprint">data</code> property like <code class="prettyprint">{&quot;data&quot;: {&quot;foo&quot;: &quot;bar&quot;}}</code>. If a user <code class="prettyprint">{user_id: 1, {foo: &quot;bar&quot;}}</code> exists, and we do a PUT request to <code class="prettyprint">http://connect.getorbita.io/api/v1/users/1/bucket</code> with payload of <code class="prettyprint">{&quot;data&quot;: {&quot;bar&quot;: &quot;baz&quot;}</code>, the updated record will be <code class="prettyprint">{user_id: 1, {foo: &quot;bar&quot;, bar: &quot;baz&quot;}}</code> where <code class="prettyprint">data</code> property is merged with the <code class="prettyprint">data</code> property of the payload.</p></li>
<li><p>GET - this gets a user record given a user <code class="prettyprint">id</code>. Just send a GET request to <code class="prettyprint">http://connect.getorbita.io/api/v1/users/1/bucket</code>.</p></li>
<li><p>DELETE - deletes a user record given a user <code class="prettyprint">id</code>. Just send a DELETE request to <code class="prettyprint">http://connect.getorbita.io/api/v1/users/1/bucket</code></p></li>
</ol>

<p>When making the requests, keep in mind that an access token is required. You will need to get an access token from oauth or oauth-staging. Below are some sample access tokens I use for testing that have expiration times set in the far future.</p>

<ul>
<li><code class="prettyprint">http://connect.getorbita.io/api/v1/users/1/bucket?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyIjp7ImlkIjoyLCJlbWFpbCI6ImdqYWxkb244NUBnbWFpbC5jb20iLCJmaXJzdF9uYW1lIjoiIiwiZGF0ZSI6IjIwMTYtMDMtMjJUMDY6NTk6NTYuODA1KzAxOjAwIn19.9dgb2dvq4Qmya13PANLHLxWRMAnXF2ihNcrUThpOCqE</code></li>
<li><code class="prettyprint">http://connect-staging.getorbita.io/api/v1/users/1/bucket?access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyIjp7ImlkIjoyLCJlbWFpbCI6ImdqYWxkb244NUBnbWFpbC5jb20iLCJmaXJzdF9uYW1lIjpudWxsLCJkYXRlIjoiMjAxNi0wMy0yMVQxMTo0OToxOC44NzcrMDE6MDAifX0.OdBAm883FqlHyBOob9t4TEk2bDLgNhJVIm6zDE5oxxs</code></li>
</ul>

<h1 id="how-to-setup-a-new-orbita-instance">How to Setup a New Orbita Instance</h1>

<h2 id="configuration">Configuration</h2>

<p>We will need to edit the <a href="https://git.coders51.com/coders51/orbita/blob/master/config.exs">config.exs</a> file found in the root directory of the <code class="prettyprint">orbita</code> repo. A <code class="prettyprint">get_configs/1</code> function is expected for the instance you want to setup. The <code class="prettyprint">get_configs/1</code> function should return a keyword list with certain options. If you want to generate configs for a <code class="prettyprint">&quot;foo&quot;</code> instance, we define the following <code class="prettyprint">get_configs/1</code> function:</p>
<pre class="highlight ruby"><code>  <span class="k">def</span> <span class="nf">get_configs</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">[</span><span class="ss">apps: </span><span class="vi">@apps</span><span class="p">,</span> <span class="c1"># a list of apps you want to generate configs for. refer to @apps to see all available options</span>
     <span class="ss">ports: </span><span class="sx">%{
       "networking" =&gt; "4030",
       "notifications" =&gt; "4130",
       "cookietrack" =&gt; "9040"}</span><span class="p">,</span> <span class="c1"># a mapping of ports for certain apps</span>
     <span class="ss">domain: </span><span class="s2">"foo.com"</span><span class="p">,</span> <span class="c1"># the parent domain for the services</span>
     <span class="ss">namespace: </span><span class="s2">"foo"</span><span class="p">,</span> <span class="c1"># the namespace we use to refer to this instance. typically the same as the argument expected by  the function</span>
     <span class="ss">server: </span><span class="s2">"deploy@orbita.lan.coders51.com"</span><span class="p">,</span> <span class="c1"># the server we will deploy to</span>
     <span class="ss">env: </span><span class="s2">"production"</span><span class="p">]</span> <span class="c1"># either "staging" or "production" environment</span>
  <span class="k">end</span>
</code></pre>

<h2 id="generation-of-configurations">Generation of Configurations</h2>

<p>From the command line, go to the root of the <code class="prettyprint">orbita</code> directory. From there, we run the following:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>./gen_configs -n foo
</code></pre>

<p>The above command generates capistrano, nginx, supervisor, unicorn, thin, secrets.yml and vm.args configs for each of the apps depending on the templates that exist for them. You can check the templates available for each app under <code class="prettyprint">./templates</code> directory in the orbita repo.</p>

<h2 id="first-deployment-of-each-service-app">First Deployment of Each Service/App</h2>

<p>Before deploying, go to the repo of either Networking, Notifications or Oauth and then run the ff:
<code class="prettyprint">shell
$ bundle exec cap foo_production setup:amqp
</code></p>

<p>The above command creates the rabbitmq vhost for the instance and a corresponding user with admin-like privileges. This is an important step so that the services can actually communicate with each other and is required so that you can deploy multiple orbita instances on one server.</p>

<h3 id="all-services-except-dashboard-and-components-cdn-are-deployed-this-way">All services except Dashboard and Components/CDN are deployed this way:</h3>

<p>Make sure you are in the root directory of the service we want to deploy.
<code class="prettyprint">shell
$ git commit -am &quot;foo_production deploy configs&quot;
$ bundle exec cap foo_production deploy:initial # if env is &quot;staging&quot; then it should be foo_staging
</code></p>

<p>Note that we <code class="prettyprint">deploy:initial</code>. This is different from the capistrano <code class="prettyprint">deploy</code> task we will use in succeeding deploys since it includes some setup tasks such as uploading of nginx and supervisor configs.</p>

<h3 id="for-dashboard-we-do-the-ff">For Dashboard, we do the ff:</h3>

<p>Before deploying, you will need to add the necessary configs for your deployment to <code class="prettyprint">config/environment.js</code>. Commit and push that to the remote host before running the below commands.</p>
<pre class="highlight shell"><code><span class="gp">$ </span>./setup_deploy foo_dashboard_production deploy@server.com  <span class="c"># the first arg is the name of the dashboard app which is the namespace + dashboard + env</span>
<span class="gp">$ </span>ember deploy foo_dashboard_production
</code></pre>

<h3 id="for-components-cdn-we-do">For Components/CDN, we do:</h3>
<pre class="highlight shell"><code><span class="gp">$ </span>git commit -am <span class="s2">"foo_production deploy configs"</span>
<span class="gp">$ </span>bundle <span class="nb">exec </span>cap foo_production copy:initial
</code></pre>

<h3 id="important-notes">Important Notes</h3>

<ul>
<li>You can check the services that are running in the server with <code class="prettyprint">sudo supervisorctl status</code>. Watch out for services that keep on restarting. You will need to look into the logs for those services to find out why they stop.</li>
<li>When building releases for the elixir apps(this happens every time you deploy), you may encounter errors that have to do with <code class="prettyprint">:idna</code> or some other dependencies failing to compile. Some other Elixir libraries require more memory to compile and will fail in compiling in the server. If building the release locally works fine with the same configs, then you likely need to increase the memory for your server.</li>
<li>Some apps such as Demo and Dashboard, require oauth configuration. This means you will need to add the Application to the Connect service. Once added there and set to <code class="prettyprint">trusted</code>, copy their <code class="prettyprint">client_secret</code> and <code class="prettyprint">client_id</code> to your instance&rsquo;s Demo secrets.yml file which would be <code class="prettyprint">foo_demo_production.secrets.yml</code>. For Dashboard, you just need the <code class="prettyprint">client_id</code> copied to <code class="prettyprint">config/environment.js</code>under <code class="prettyprint">Env.torii.providers.oauth51.apiKey</code>.</li>
</ul>

<h2 id="staging-deploy">Staging Deploy</h2>

<p>For every application just run <code class="prettyprint">cap staging deploy</code></p>

<h2 id="staging-remote-urls">Staging Remote URLs</h2>

<ul>
<li>http://connect.mysite-staging.com -&gt; It&rsquo;s the ouath server -&gt; mta-oauth</li>
<li>http://portal.mysite-staging.com -&gt; It&rsquo;s the portal -&gt; mta-test-jwt</li>
<li>http://developers.mysite-staging.com -&gt; It&rsquo;s the site for the developers -&gt; mta-developers</li>
<li>http://networking.mysite-staging.com -&gt; It&rsquo;s the networking service -&gt; mta-networking</li>
<li>http://notification.mysite-staging.com -&gt; It&rsquo;s the notification server -&gt; mta-notification</li>
<li>http://cdn.mysite-staging.com -&gt; We use for distribute the js compoments file -&gt; mta-components</li>
</ul>

<h1 id="vagrant-provisioning">Vagrant Provisioning</h1>

<ol>
<li>Install Ansible and Vagrant</li>
<li>Clone this repository and go to its root directory</li>
<li><code class="prettyprint">ansible-galaxy install -r requirements.yml</code> try <code class="prettyprint">sudo</code> if the command fails with permission error.</li>
<li><code class="prettyprint">vagrant up</code> - This will take a long time as it will provision your vagrant machine with all the dependencies of Orbita&rsquo;s services.</li>
<li><code class="prettyprint">vagrant ssh</code> - Logs into your Orbita dev machine</li>
<li><code class="prettyprint">orbita-components</code> folder is shared between the local machine and the vagrant vm with rsync. The folder is synced <strong>only</strong> when vagrant vm is initialized. If you want a live rsync (necessary if you develop orbita-components) you need to execute also <code class="prettyprint">vagrant rsync-auto</code></li>
<li>Run <code class="prettyprint">./setup.sh</code> to initialize all the repositories (<code class="prettyprint">orbita-networking</code>, <code class="prettyprint">orbita-notifications</code>, and so on)</li>
<li><code class="prettyprint">foreman start</code> - Start all services</li>
</ol>

<ul>
<li>Note that all the Orbita repositories must exist in your computer. They need to be located in the same directory as this Orbita repo.</li>
<li>Make sure that the forwarded ports found in the Vagrantfile are open in your host computer. <code class="prettyprint">vagrant up</code> will fail if those ports aren&rsquo;t available.</li>
<li>If you want to start services separately, refer to the Procfile to see how to start them.</li>
<li>If <code class="prettyprint">vagrant up</code> fails, you can run provisioning again by running <code class="prettyprint">vagrant provision</code>.</li>
</ul>

<h1 id="provisioning-staging-server">Provisioning Staging Server</h1>

<ol>
<li>Install Ansible in your dev machine</li>
<li>Set staging host in <code class="prettyprint">/etc/ansible/hosts</code> by adding the following to that file:
<code class="prettyprint">ruby
[staging]
deploy@orbita.lan.coders51.com
</code></li>
<li>Git clone the https://git.coders51.com/coders51/orbita repository</li>
<li>From the root of that repository, run <code class="prettyprint">ansible-playbook provision/staging.yml</code></li>
<li>If you encounter any bugs, report them by creating an issue at https://git.coders51.com/coders51/orbita/issues</li>
</ol>

<h1 id="deploying-orbita-services">Deploying Orbita Services</h1>

<h2 id="deploying-services-except-dashboard">Deploying Services Except Dashboard</h2>

<p>$ bundle exec cap foo_production deploy</p>
<pre class="highlight shell"><code><span class="gp">$ </span>bundle <span class="nb">exec </span>cap foo_production deploy
</code></pre>

<h2 id="deploying-dashboard">Deploying Dashboard</h2>

<p>$ ember deploy foo_dashboard_production</p>
<pre class="highlight shell"><code><span class="gp">$ </span>ember deploy foo_dashboard_production
</code></pre>

<h1 id="dev-machine-setup">Dev Machine Setup</h1>

<ol>
<li>Install Ansible and Vagrant</li>
<li>Go this repo&rsquo;s root directory</li>
<li><code class="prettyprint">ansible-galaxy install -r requirements.yml</code> try <code class="prettyprint">sudo</code> if the command file with permission error.</li>
<li><code class="prettyprint">vagrant up</code> - This will take a long time as it will provision your vagrant machine with all the dependencies of Orbita&rsquo;s services.</li>
<li><code class="prettyprint">vagrant ssh</code> - Logs into your Orbita dev machine</li>
<li>Run <code class="prettyprint">./setup.sh</code> to initialize all the repositories (<code class="prettyprint">orbita-networking</code>, <code class="prettyprint">orbita-notifications</code>, and so on)</li>
<li><code class="prettyprint">foreman start</code> - Start all services</li>
</ol>

<ul>
<li>Note that all the Orbita repositories must exist in your computer. They need to be located in the same directory as this Orbita repo.</li>
<li>Make sure that the forwarded ports found in the Vagrantfile are open in your host computer. <code class="prettyprint">vagrant up</code> will fail if those ports aren&rsquo;t available.</li>
<li>If you want to start services separately, refer to the Vagrantfile to see how to start them.</li>
</ul>

          <h1 id="how-to-receive-orbita-notification">How to receive orbita notification</h1>

<p>All the orbita notifications are sent through the exchange <strong>orbita_exchange</strong> of type <a href="https://www.rabbitmq.com/tutorials/tutorial-five-python.html">topic</a>. There are two main routing key in orbita one for receive notification and one for send command. To receive notification you should create a new queue with routing key of type <code class="prettyprint">#.evt.#</code> see this exampel in ruby using <a href="http://rubybunny.info/">bunny</a> (There are a lot of client in other <a href="https://www.rabbitmq.com/clients.html">languages</a>):</p>
<pre class="highlight ruby"><code><span class="n">connection</span> <span class="o">=</span> <span class="no">Bunny</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">amqp_opts</span><span class="p">)</span>
<span class="n">connection</span><span class="p">.</span><span class="nf">start</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">create_channel</span>
<span class="n">orbita_exchange</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">topic</span><span class="p">(</span><span class="s1">'orbita_exchange'</span><span class="p">)</span>
<span class="n">queue</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s1">'my_app_queue'</span><span class="p">,</span> <span class="ss">durable: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">auto_delete: </span><span class="kp">false</span><span class="p">)</span>
<span class="n">queue</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="ss">routing_key: </span><span class="s1">'#.evt.#'</span><span class="p">)</span>
</code></pre>

<p>The first part of routing key is reserved for future use but the second part, after <code class="prettyprint">evt</code>, should be specialized to receive only event from oauth, or from my_app. For example if you want receive all event from connect you should bind your queue in this way:</p>
<pre class="highlight ruby"><code><span class="n">connection</span> <span class="o">=</span> <span class="no">Bunny</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">amqp_opts</span><span class="p">)</span>
<span class="n">connection</span><span class="p">.</span><span class="nf">start</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">create_channel</span>
<span class="n">orbita_exchange</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">topic</span><span class="p">(</span><span class="s1">'orbita_exchange'</span><span class="p">)</span>
<span class="n">queue</span> <span class="o">=</span> <span class="n">channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="s1">'my_app_queue'</span><span class="p">,</span> <span class="ss">durable: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">auto_delete: </span><span class="kp">false</span><span class="p">)</span>
<span class="n">queue</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="ss">routing_key: </span><span class="s1">'#.evt.oauth.#'</span><span class="p">)</span>
</code></pre>

<h1 id="how-to-send-orbita-command">How to send orbita command</h1>

<p>Sending a command is very similar to receive an event. The application should publish a message on &lsquo;orbita_exchange&rsquo; with the appropiate routing key. The routing key is composed by a first part that should be fixed <code class="prettyprint">0.0.cmd.</code> and a second part that identify the <em>type</em> of the message. For example you could send a generic notification tha cna be dispatched via WS and mobile sending a message of this type:</p>
<pre class="highlight json"><code><span class="err">message</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2cb56d59-ed41-4aad-9a7d-765fa89daa4b"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GenericNotification"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_app"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"emitted_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2016-09-22T16:24:13Z"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"payload"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"from"</span><span class="p">:</span><span class="w"> </span><span class="mi">23</span><span class="p">,</span><span class="w">
    </span><span class="nt">"to"</span><span class="p">:</span><span class="w"> </span><span class="mi">23</span><span class="p">,</span><span class="w">
    </span><span class="nt">"link"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"This is a generic notification"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>with routing key eqaul to <code class="prettyprint">0.0.cmd.notification</code>. Publishing this message on <code class="prettyprint">orbita_exchange</code> will bring up a notification on the bar of the user with id 23.</p>

<h1 id="format-of-the-message">Format of the message</h1>

<p>The format of the events and the commands is very similar:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"a75fbf6e-4c36-48fb-9051-33a2f9600e9a"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"emited_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2016-09-22T16:08:15Z"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GenericNotification"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_app"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"payload"</span><span class="p">:</span><span class="w"> </span><span class="err">...</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<ul>
<li><code class="prettyprint">id</code> is a classic uuid that can used to differentiate all the messages</li>
<li><code class="prettyprint">emitted_at</code> is the time of the server in UTC iso8601 format. This field should be used to reorder messages sent form the same source. <em>This time can NOT be used to apply a gloabal order between messages</em></li>
<li><code class="prettyprint">type</code> is the type of teh message that can categorize the message.</li>
<li><code class="prettyprint">payload</code> is something that the application should use to describe the event and/or the command</li>
</ul>

<p><strong>Warning</strong>: sometime some messages can contain other fields but it&rsquo;s cant be used directly by other aplication because can be removed or changed. In general only this fields should be considered always present and every fileds related to particular message should be put in the payload.</p>

<h1 id="import-users-in-oauth">Import users in OAuth</h1>

<p>It&rsquo;s possible import users from other applications in Orbita OAuth. There are a rake task that can be used to import data in OAuth from csv file. The task is <code class="prettyprint">bundle exec rake orbita:oauth:import_users</code>. The format of the csv file is similar to table of the user:</p>

<ul>
<li>email</li>
<li>encrypted_password</li>
<li>remember_created_at</li>
<li>sign_in_count</li>
<li>current_sign_in_at</li>
<li>last_sign_in_at</li>
<li>current_sign_in_ip</li>
<li>last_sign_in_ip</li>
<li>failed_attempts</li>
<li>unlock_token</li>
<li>locked_at</li>
<li>username</li>
<li>first_name</li>
<li>last_name</li>
<li>birthday</li>
<li>gender</li>
<li>newsletter_subscribed</li>
<li>is_admin</li>
<li>is_dev</li>
<li>parent_email</li>
<li>parent_first_name</li>
<li>parent_last_name</li>
<li>parent_birthday</li>
<li>created_at</li>
<li>updated_at</li>
<li>avatar_file_name</li>
<li>avatar_content_type</li>
<li>avatar_file_size</li>
<li>avatar_updated_at</li>
<li>is_moderator</li>
<li>confirmation_token</li>
<li>confirmed_at</li>
<li>confirmation_sent_at</li>
<li>unconfirmed_email</li>
<li>language</li>
<li>invitation_token</li>
<li>invitation_created_at</li>
<li>invitation_sent_at</li>
<li>invitation_accepted_at</li>
<li>invitation_limit</li>
<li>invite_redirect_url</li>
<li>tos</li>
<li>privacy</li>
<li>measure_system</li>
<li>country</li>
<li>province</li>
<li>city</li>
<li>address</li>
<li>zip</li>
</ul>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="shell">shell</a>
                <a href="#" data-language-name="ruby">ruby</a>
                <a href="#" data-language-name="javascript">javascript</a>
                <a href="#" data-language-name="html">html</a>
          </div>
      </div>
    </div>
  </body>
</html>
